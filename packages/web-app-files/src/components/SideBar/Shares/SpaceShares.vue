<template>
  <div id="oc-files-sharing-sidebar" class="oc-position-relative">
    <oc-loader v-if="sharesLoading" :aria-label="$gettext('Loading people list')" />
    <template v-else>
      <invite-collaborator-form v-if="currentUserCanShare" key="new-collaborator" class="oc-my-s" />
      <template v-if="hasCollaborators">
        <ul
          id="files-collaborators-list"
          class="oc-list oc-list-divider oc-overflow-hidden oc-m-rm"
          :aria-label="$gettext('Share receivers')"
        >
          <li v-for="collaborator in currentFileOutgoingCollaborators" :key="collaborator.key">
            <collaborator-list-item
              :share="collaborator"
              :modifiable="isModifiable(collaborator)"
              @onDelete="$_ocCollaborators_deleteShare(collaborator)"
            />
          </li>
        </ul>
      </template>
    </template>
  </div>
</template>

<script>
import { mapGetters, mapActions, mapState } from 'vuex'
import { useStore } from 'web-pkg/src/composables'
import { clientService } from 'web-pkg/src/services'
import CollaboratorListItem from './Collaborators/ListItem.vue'
import InviteCollaboratorForm from './InviteCollaborator/InviteCollaboratorForm.vue'
import { ShareTypes, spaceManager } from '../../../helpers/share'
import { createLocationSpaces, isLocationSpacesActive } from '../../../router'
import { useTask } from 'vue-concurrency'

export default {
  title: ($gettext) => {
    return $gettext('People')
  },
  name: 'SpaceShares',
  components: {
    CollaboratorListItem,
    InviteCollaboratorForm
  },
  inject: ['displayedItem'],
  setup() {
    const store = useStore()
    const graphClient = clientService.graphAuthenticated(
      store.getters.configuration.server,
      store.getters.getToken
    )

    const loadSharesTask = useTask(function* (signal, ref) {
      ref.loadCurrentFileOutgoingShares({
        client: graphClient,
        path: ref.space.id,
        space: ref.space
      })
    })

    return { graphClient, loadSharesTask }
  },
  computed: {
    ...mapGetters('Files', [
      'highlightedFile',
      'currentFileOutgoingCollaborators',
      'currentFileOutgoingSharesLoading',
      'sharesTreeLoading'
    ]),
    ...mapState(['user']),
    space() {
      return this.displayedItem.value
    },
    sharesLoading() {
      return this.currentFileOutgoingSharesLoading
    },
    hasCollaborators() {
      return this.currentFileOutgoingCollaborators.length > 0
    },
    currentUserCanShare() {
      return this.currentUserIsManager
    },
    currentUserIsManager() {
      const currentUserCollaborator = this.currentFileOutgoingCollaborators.find(
        (collaborator) => collaborator.collaborator.name === this.user.id
      )

      return currentUserCollaborator?.role?.name === spaceManager.name
    }
  },
  mounted() {
    this.loadSharesTask.perform(this)
  },
  methods: {
    ...mapActions('Files', ['loadCurrentFileOutgoingShares', 'deleteShare']),

    isModifiable(share) {
      if (share.shareType === ShareTypes.space.value) {
        if (this.currentFileOutgoingCollaborators.length < 2) {
          return false
        }

        const managers = this.currentFileOutgoingCollaborators.filter(
          (collaborator) => collaborator.role.name === spaceManager.name
        )

        // only one manager -> can't remove those
        if (managers.length < 2 && share.role.name === spaceManager.name) {
          return false
        }

        return this.currentUserIsManager
      }

      return true
    },
    $_ocCollaborators_deleteShare(share) {
      this.deleteShare({
        client: this.$client,
        share: share,
        resource: this.highlightedFile
      }).then(() => {
        // current user was removed from the share.
        if (share.collaborator.name === this.user.id) {
          if (isLocationSpacesActive(this.$router, 'files-spaces-projects')) {
            return this.$router.go(0)
          }
          return this.$router.push(createLocationSpaces('files-spaces-projects'))
        }
      })
    }
  }
}
</script>

<style>
.avatars-wrapper {
  height: 40px;
}
</style>
